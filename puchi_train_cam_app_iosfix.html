<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>プチ電車ペンプロッタ2：アーム＋カム</title>
<style>
:root { --bg:#0b0c10; --panel:#141722; --ink:#e9ecf1; --muted:#aab2c0; --line:#2a3142; }
*{ box-sizing:border-box; }
body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--ink); }
header{ padding:12px 14px; border-bottom:1px solid var(--line); }
header h1{ margin:0; font-size:15px; }
header p{ margin:6px 0 0; font-size:12px; color:var(--muted); }
.wrap{ display:grid; grid-template-columns: minmax(260px,360px) 1fr; gap:10px; padding:10px; }
@media (max-width:900px){ .wrap{ grid-template-columns: 1fr; } }
.card{ background:#141722; border:1px solid var(--line); border-radius:14px; padding:10px; }
h2{ margin:0 0 8px; font-size:13px; }
.controls{ display:grid; gap:8px; }
.controls .row{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
.controls label{ font-size:11px; color:var(--muted); }
.controls input, .controls select{ width:100%; padding:7px; border-radius:10px; border:1px solid var(--line); background:#0f1220; color:var(--ink); }
button{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#0f1220; color:var(--ink); font-weight:600; }
button.primary{ background:#0b2733; border-color:#2b8ab1; }
.canvasWrap{ width:100%; aspect-ratio: 3 / 4; }
canvas{ width:100%; height:100%; display:block; border-radius:12px; border:1px solid var(--line); background:#070812; }
.small{ font-size:11px; color:var(--muted); margin-top:6px; }
</style>
</head>
<body>
<header>
<h1>プチ電車ペンプロッタ2</h1>
<p>iPhone対応：縦比固定＆タップ再生</p>
</header>

<div class="wrap">
<section class="card controls">
<h2>操作</h2>
<div class="row">
<div><label>アーム長 l</label><input id="l" type="number" value="90"></div>
<div><label>Yオフセット</label><input id="y0" type="number" value="130"></div>
</div>
<div class="row">
<div><label>図形</label>
<select id="shape"><option value="square">正方形</option><option value="star">星</option></select>
</div>
<div><label>点数</label><input id="N" type="number" value="600"></div>
</div>
<button class="primary" id="play">▶ タップして再生</button>
<button id="pause">⏸ 停止</button>
<div class="small">※ iPhoneは自動再生不可。必ずタップしてください。</div>
</section>

<section class="card">
<h2>リンク機構アニメ</h2>
<div class="canvasWrap"><canvas id="anim" width="600" height="800"></canvas></div>
<div class="small">縦横比3:4固定</div>
</section>
</div>

<script>
const TAU=Math.PI*2;
const c=document.getElementById('anim'), ctx=c.getContext('2d');
let playing=false, t=0, state=null;

function compute(){
  const l=+document.getElementById('l').value;
  const y0=+document.getElementById('y0').value;
  const N=+document.getElementById('N').value;
  const shape=document.getElementById('shape').value;
  const A=[],B=[],M=[];
  for(let i=0;i<N;i++){
    const th=TAU*i/N;
    let rho=35;
    if(shape==="star") rho=20+20*Math.cos(5*th);
    const x=rho*Math.cos(th);
    const y=rho*Math.sin(th)+y0;
    const r=Math.hypot(x,y);
    const phi=Math.atan2(y,x);
    const g=Math.acos(Math.min(r/(2*l),0.999));
    const a=phi+g, b=phi-g;
    A.push([l*Math.cos(a),l*Math.sin(a)]);
    B.push([l*Math.cos(b),l*Math.sin(b)]);
    M.push([x,y]);
  }
  state={A,B,M,N};
}

function draw(){
  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.translate(c.width/2,c.height*0.9);
  ctx.scale(1,-1);
  const s=2.2; ctx.scale(s,s);
  const i=Math.floor(t)%state.N;
  const O=[0,0], A=state.A[i], B=state.B[i], M=state.M[i];
  function seg(p,q,col){
    ctx.strokeStyle=col; ctx.lineWidth=3/s;
    ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.lineTo(q[0],q[1]); ctx.stroke();
  }
  seg(O,A,"#60a5fa"); seg(O,B,"#fb923c"); seg(A,M,"#22c55e"); seg(B,M,"#ef4444");
  ctx.restore();
}

function tick(){
  if(!playing) return;
  t=(t+1)%state.N; draw(); requestAnimationFrame(tick);
}

document.getElementById('play').onclick=()=>{ compute(); playing=true; tick(); };
document.getElementById('pause').onclick=()=>playing=false;
compute(); draw();
</script>
</body>
</html>
