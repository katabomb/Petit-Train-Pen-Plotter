<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç·šæ–‡ãƒ¡ãƒ¼ã‚«ãƒ¼ v0.3.1ï¼ˆè·é›¢ï¼‹è§’åº¦ã®é–“å¼•ãï¼‰</title>
<style>
:root{--bg:#fff;--ink:#000;--line:#ddd;--btn:#f4f4f4;--accent:#0b66ff;--preview:#888}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#fff;color:#000}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,select,input{border:1px solid var(--line);background:var(--btn);border-radius:8px;padding:6px 10px}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
main{padding:10px}
.canvasWrap{border:1px solid var(--line);border-radius:10px;max-width:520px;margin:0 auto}
canvas{display:block;width:100%;aspect-ratio:1/1;background:#fff;touch-action:none}
textarea{width:100%;min-height:160px;margin-top:10px;border:1px solid var(--line);border-radius:8px;padding:8px;font-family:monospace}
.small{font-size:12px;color:#555}
</style>
</head>
<body>

<header>
<div class="row">
<select id="frameSel">
<option value="65">æ  65mm</option>
<option value="70" selected>æ  70mm</option>
<option value="72">æ  72mm</option>
<option value="75">æ  75mm</option>
</select>
<label><input type="checkbox" id="simplifyOn" checked> é–“å¼•ãON</label>
<label>å¼·ã• <input type="range" id="angleThr" min="2" max="20" value="6"></label>
<button id="undo">â†©ï¸</button>
<button id="clear">ğŸ§½</button>
<button class="primary" id="export">ç·šæ–‡ç”Ÿæˆ</button>
</div>
<div class="small">è·é›¢(0.4mm)+è§’åº¦ é–“å¼•ãï¼ç°è‰²ï¼é–“å¼•ãå¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
</header>

<main>
<div class="canvasWrap">
<canvas id="c"></canvas>
</div>
<textarea id="out"></textarea>
</main>

<script>
const c=document.getElementById("c");
const ctx=c.getContext("2d");
const frameSel=document.getElementById("frameSel");
const simplifyOn=document.getElementById("simplifyOn");
const angleThr=document.getElementById("angleThr");
const out=document.getElementById("out");

let strokes=[], cur=null, drawing=false;

function resize(){
 const size=c.parentElement.clientWidth;
 c.width=c.height=size;
 redraw();
}
window.addEventListener("resize",resize);

function redraw(){
 ctx.clearRect(0,0,c.width,c.height);
 ctx.strokeStyle="#bbb"; ctx.strokeRect(0,0,c.width,c.height);

 ctx.strokeStyle="#000"; ctx.lineWidth=2;
 for(const s of strokes) drawStroke(s);

 if(simplifyOn.checked){
   ctx.strokeStyle="#888";
   for(const s of strokes){
     const simp=simplifyStroke(s);
     drawStroke(simp);
   }
 }

 if(cur){ ctx.strokeStyle="#000"; drawStroke(cur); }
}

function drawStroke(s){
 if(s.length<2) return;
 ctx.beginPath();
 ctx.moveTo(s[0].x,s[0].y);
 for(let i=1;i<s.length;i++) ctx.lineTo(s[i].x,s[i].y);
 ctx.stroke();
}

function pos(e){ return {x:e.offsetX,y:e.offsetY}; }

c.addEventListener("pointerdown",e=>{
 drawing=true; cur=[pos(e)]; redraw();
});
c.addEventListener("pointermove",e=>{
 if(!drawing) return;
 const p=pos(e), l=cur[cur.length-1];
 if(Math.hypot(p.x-l.x,p.y-l.y)>1){ cur.push(p); redraw(); }
});
c.addEventListener("pointerup",()=>{
 if(cur&&cur.length>1) strokes.push(cur);
 cur=null; drawing=false; redraw();
});

document.getElementById("undo").onclick=()=>{strokes.pop(); redraw();};
document.getElementById("clear").onclick=()=>{strokes=[];cur=null;out.value=""; redraw();};

function simplifyStroke(s){
 if(s.length<3) return s.slice();
 const mm=+frameSel.value;
 const scale=c.width/mm;
 const distThr=0.4*scale;
 const angThr=angleThr.value*Math.PI/180;
 let res=[s[0]];
 for(let i=1;i<s.length-1;i++){
   const a=res[res.length-1], b=s[i], c2=s[i+1];
   const d=Math.hypot(b.x-a.x,b.y-a.y);
   if(d<distThr) continue;
   const v1=[b.x-a.x,b.y-a.y], v2=[c2.x-b.x,c2.y-b.y];
   const ang=Math.acos(
     (v1[0]*v2[0]+v1[1]*v2[1])/
     (Math.hypot(v1[0],v1[1])*Math.hypot(v2[0],v2[1]))
   );
   if(ang<angThr) continue;
   res.push(b);
 }
 res.push(s[s.length-1]);
 return res;
}

document.getElementById("export").onclick=()=>{
 const mm=+frameSel.value;
 const scale=c.width/mm;
 let lines=[];
 for(const s0 of strokes){
   const s=simplifyOn.checked ? simplifyStroke(s0) : s0;
   let prev=null;
   for(const p of s){
     let x=p.x/scale, y=(c.height-p.y)/scale;
     if(prev && Math.hypot(x-prev[0],y-prev[1])<0.4) continue;
     prev=[x,y];
     lines.push(`${x.toFixed(2)},${y.toFixed(2)}`);
   }
   lines.push("");
 }
 while(lines.length && lines[lines.length-1]==="") lines.pop();
 out.value=lines.join("\n");
};

resize();
</script>
</body>
</html>
