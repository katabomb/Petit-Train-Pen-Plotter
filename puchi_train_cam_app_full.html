<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>プチ電車ペンプロッタ カム生成（フル版）</title>
<style>
html,body{
  margin:0; padding:0;
  background:#fff; color:#000;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
.wrapper{max-width:1200px;margin:auto;padding:10px;}
textarea{width:100%;height:120px;font-family:monospace;}
button{margin:4px;padding:6px 10px;}
.row{display:flex;flex-wrap:wrap;gap:10px;}
canvas{background:#fff;border:1px solid #ccc;}
.small{font-size:12px;color:#555;}
</style>
</head>
<body>
<div class="wrapper">

<h2>線文貼り付け</h2>
<textarea id="linedata" placeholder="ここに線文を貼り付け"></textarea>
<button onclick="recalc()">再計算</button>
<button onclick="play()">▶ 再生</button>
<button onclick="stop()">⏸ 停止</button>

<p class="small">
※ 線文は中央原点(mm)前提 / iPad対応 / αβZ出力
</p>

<div class="row">
  <canvas id="anim" width="500" height="500"></canvas>
  <canvas id="camA" width="300" height="300"></canvas>
  <canvas id="camB" width="300" height="300"></canvas>
  <canvas id="camZ" width="300" height="300"></canvas>
</div>

<button onclick="saveCam('camA')">αカムPNG保存</button>
<button onclick="saveCam('camB')">βカムPNG保存</button>
<button onclick="saveCam('camZ')">ZカムPNG保存</button>

</div>

<script>
const TAU=Math.PI*2;
let pts=[], idx=0, playing=false, raf;

const anim=document.getElementById("anim");
const actx=anim.getContext("2d");
const cams={
 A:document.getElementById("camA").getContext("2d"),
 B:document.getElementById("camB").getContext("2d"),
 Z:document.getElementById("camZ").getContext("2d")
};

function recalc(){
  const t=document.getElementById("linedata").value.trim();
  pts=[];
  t.split(/\\n+/).forEach(l=>{
    const a=l.trim().split(/[, ]+/);
    if(a.length>=2) pts.push({x:+a[0],y:+a[1]});
  });
  idx=0;
  drawAll();
}

function play(){
  if(playing||pts.length<2) return;
  playing=true;
  loop();
}
function stop(){
  playing=false;
  if(raf) cancelAnimationFrame(raf);
}

function loop(){
  if(!playing) return;
  idx=(idx+1)%pts.length;
  drawAll();
  raf=requestAnimationFrame(loop);
}

function drawAll(){
  drawAnim();
  drawCam(cams.A,0);
  drawCam(cams.B,TAU/3);
  drawCam(cams.Z,TAU*0.7);
}

function drawAnim(){
  actx.clearRect(0,0,500,500);
  actx.strokeRect(0,0,500,500);
  if(!pts.length) return;
  const p=pts[idx];
  const x=250+p.x;
  const y=250-p.y;
  actx.beginPath();
  actx.arc(x,y,4,0,TAU);
  actx.fill();
}

function drawCam(ctx,phase){
  ctx.clearRect(0,0,300,300);
  ctx.strokeStyle="#000";
  ctx.beginPath();
  ctx.arc(150,150,120,0,TAU);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(150,150);
  ctx.lineTo(
    150+120*Math.cos(idx/pts.length*TAU+phase),
    150+120*Math.sin(idx/pts.length*TAU+phase)
  );
  ctx.stroke();
}

function saveCam(id){
  const c=document.getElementById(id);
  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download=id+".png";
  a.click();
}
</script>
</body>
</html>