<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>プチ電車ペンプロッタ ABZ カム生成</title>
<style>
  body {
    margin: 0;
    background: #fff;
    font-family: system-ui, sans-serif;
    color: #222;
  }
  .wrap {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 8px;
    padding: 8px;
  }
  textarea {
    width: 100%;
    height: 260px;
    font-family: monospace;
    font-size: 12px;
  }
  canvas {
    background: #fff;
    border: 1px solid #ccc;
  }
  button {
    margin: 4px 4px 4px 0;
  }
</style>
</head>

<body>
<div class="wrap">
  <div>
    <h3>α,β,z 線文</h3>
    <textarea id="ta"></textarea><br>
    <button onclick="recalc()">再計算</button>
    <button onclick="togglePlay()">再生</button>
  </div>

  <div>
    <canvas id="cvAnim" width="600" height="400"></canvas><br>
    <canvas id="cvCamA" width="200" height="200"></canvas>
    <canvas id="cvCamB" width="200" height="200"></canvas>
    <canvas id="cvCamZ" width="200" height="200"></canvas>
  </div>
</div>

<script>
/* ===== 基本設定 ===== */
const l = 90; // アーム長
let playing = false;
let t = 0;
let samples = [];

/* ===== サンプル線文 ===== */
function sampleSquare(){
  return `
-45,45,0
-45,45,1
45,45,1
45,45,0
45,-45,0
45,-45,1
-45,-45,1
-45,-45,0
-45,45,0
`.trim();
}

/* ===== ABZ パース ===== */
function parseABZ(text){
  return text.split(/\n+/).map(line=>{
    const [a,b,z]=line.split(",").map(Number);
    if(isNaN(a)||isNaN(b)||isNaN(z)) return null;
    return {a,b,z};
  }).filter(v=>v);
}

/* ===== ペン位置計算（機構） ===== */
function penXY(a,b){
  const A = a*Math.PI/180;
  const B = b*Math.PI/180;
  const Ax = l*Math.cos(A), Ay = l*Math.sin(A);
  const Bx = l*Math.cos(B), By = l*Math.sin(B);
  return {
    Ax,Ay,Bx,By,
    x:(Ax+Bx)/2,
    y:(Ay+By)/2
  };
}

/* ===== 再計算 ===== */
function recalc(){
  samples = parseABZ(ta.value);
  t = 0;
  drawAll();
}

/* ===== 描画 ===== */
function drawAll(){
  drawAnim();
  drawCam(cvCamA, s=>s.a);
  drawCam(cvCamB, s=>s.b);
  drawCam(cvCamZ, s=>s.z?40:60);
}

function drawAnim(){
  const ctx=cvAnim.getContext("2d");
  ctx.clearRect(0,0,cvAnim.width,cvAnim.height);

  if(samples.length===0) return;

  // 表示固定：原点下中央
  const xmin=-2*l, xmax=2*l;
  const ymin=0, ymax=2*l;
  const sx=cvAnim.width/(xmax-xmin);
  const sy=cvAnim.height/(ymax-ymin);
  const s=Math.min(sx,sy);

  const ox=(cvAnim.width-(xmax-xmin)*s)/2 - xmin*s;
  const oy=cvAnim.height - ymin*s;

  const tx=x=>x*s+ox;
  const ty=y=>oy-y*s;

  // 軌跡
  ctx.lineWidth=2;
  for(let i=1;i<samples.length;i++){
    const p0=penXY(samples[i-1].a,samples[i-1].b);
    const p1=penXY(samples[i].a,samples[i].b);
    ctx.strokeStyle=samples[i].z?"#1a5cff":"#aaa";
    ctx.beginPath();
    ctx.moveTo(tx(p0.x),ty(p0.y));
    ctx.lineTo(tx(p1.x),ty(p1.y));
    ctx.stroke();
  }

  const cur = samples[Math.floor(t)%samples.length];
  const p = penXY(cur.a,cur.b);

  // アーム
  ctx.strokeStyle="#000";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(tx(0),ty(0));
  ctx.lineTo(tx(p.Ax),ty(p.Ay));
  ctx.lineTo(tx(p.x),ty(p.y));
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(tx(0),ty(0));
  ctx.lineTo(tx(p.Bx),ty(p.By));
  ctx.lineTo(tx(p.x),ty(p.y));
  ctx.stroke();

  // ペン
  ctx.fillStyle=cur.z?"#1a5cff":"#777";
  ctx.beginPath();
  ctx.arc(tx(p.x),ty(p.y),5,0,Math.PI*2);
  ctx.fill();
}

/* ===== カム描画 ===== */
function drawCam(cv, fn){
  const ctx=cv.getContext("2d");
  ctx.clearRect(0,0,cv.width,cv.height);
  if(samples.length===0) return;

  const cx=cv.width/2, cy=cv.height/2;
  ctx.strokeStyle="#000";
  ctx.beginPath();
  samples.forEach((s,i)=>{
    const r=fn(s);
    const th=2*Math.PI*i/samples.length;
    const x=cx+r*Math.cos(th);
    const y=cy+r*Math.sin(th);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.stroke();
}

/* ===== 再生 ===== */
function togglePlay(){
  playing=!playing;
}
function loop(){
  if(playing){
    t+=0.5;
    drawAll();
  }
  requestAnimationFrame(loop);
}
loop();

/* ===== 起動時初期化（重要） ===== */
window.addEventListener("load",()=>{
  ta.value = sampleSquare();
  recalc();
  ta.addEventListener("input",recalc);
});
</script>
</body>
</html>
