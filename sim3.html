<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ãƒ—ãƒé›»è»Šãƒšãƒ³ãƒ—ãƒ­ãƒƒã‚¿2ï½œã‚«ãƒ 1å‘¨ min/max è¡¨ç¤º</title>
<style>
  body{font-family:system-ui,Segoe UI,sans-serif;margin:10px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  canvas{border:1px solid #aaa;border-radius:10px}
  .panel{min-width:300px;max-width:480px}
  .card{border:1px solid #ddd;border-radius:12px;padding:10px 12px;margin-bottom:10px}
  label{display:grid;grid-template-columns:1fr 95px;gap:10px;align-items:center;margin:6px 0}
  input[type=range]{width:100%}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:7px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;line-height:1.6}
</style>
</head>

<body>
<div class="row">
  <canvas id="cv" width="760" height="950"></canvas>

  <div class="panel">
    <div class="card">
      <div class="btns">
        <button id="play">â–¶ å†ç”Ÿ</button>
        <button id="pause">â¸ åœæ­¢</button>
        <button id="clearTrail">ğŸ§½ ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div class="card">
      <b>å¯¸æ³•</b>
      <label>4ç¯€ãƒªãƒ³ã‚¯é•· l<input id="l" type="range" min="60" max="280" value="140"></label>
      <label>å…¥åŠ›ãƒãƒ¼é•· m<input id="m" type="range" min="80" max="520" value="260"></label>
      <label>ã‚ºãƒ¼ãƒ <input id="zoom" type="range" min="55" max="150" value="75"></label>
      <label>åŸç‚¹é«˜ã•<input id="oy" type="range" min="0.22" max="0.55" step="0.01" value="0.35"></label>
      <label>ã‚°ãƒªãƒƒãƒ‰<input id="gridStep" type="range" min="10" max="80" value="20"></label>
    </div>

    <div class="card">
      <b>å…¥åŠ›è§’</b>
      <label>Î¸A0<input id="ta0" type="range" min="-180" max="180" value="45"></label>
      <label>Î¸B0<input id="tb0" type="range" min="-180" max="180" value="135"></label>
      <label>æŒ¯å¹…A<input id="ampA" type="range" min="0" max="140" value="35"></label>
      <label>æŒ¯å¹…B<input id="ampB" type="range" min="0" max="140" value="55"></label>
      <label>ä½ç›¸å·® Ï†<input id="phi" type="range" min="-180" max="180" value="90"></label>
      <label>é€Ÿåº¦<input id="spd" type="range" min="5" max="240" value="70"></label>
    </div>

    <div class="card">
      <b>å…±é€šã‚«ãƒ ä¸­å¿ƒ</b>
      <label>Cx<input id="cx" type="range" min="-340" max="340" value="0"></label>
      <label>Cy<input id="cy" type="range" min="-900" max="-40" value="-260"></label>
    </div>

    <div class="card">
      <div class="mono" id="readout"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const rad = d => d*Math.PI/180;
  let running = true;
  let t = 0;

  // ===== è»Œè·¡ï¼ˆ5å‘¨åˆ†ï¼‰ =====
  const trail = [];
  const TRAIL_MAX = 2500;

  // ===== ã‚«ãƒ 1å‘¨ã”ã¨ã® min/max ç®¡ç† =====
  let rA_min_cur = Infinity, rA_max_cur = -Infinity;
  let rB_min_cur = Infinity, rB_max_cur = -Infinity;
  let rA_min_last = NaN, rA_max_last = NaN;
  let rB_min_last = NaN, rB_max_last = NaN;
  let camAnglePrev = 0;

  function W(p){
    const s = zoom.value/100;
    return {
      x: cv.width/2 + p.x*s,
      y: cv.height*oy.value - p.y*s
    };
  }

  function drawLine(p,q,w,c){
    const a=W(p), b=W(q);
    ctx.strokeStyle=c; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  }
  function drawDot(p,r,c){
    const a=W(p);
    ctx.fillStyle=c;
    ctx.beginPath(); ctx.arc(a.x,a.y,r,0,Math.PI*2); ctx.fill();
  }

  function drawGrid(){
    const s = zoom.value/100;
    const step = gridStep.value;
    const ox = cv.width/2;
    const oyPix = cv.height*oy.value;
    ctx.strokeStyle="#eee"; ctx.lineWidth=1;
    for(let x=-1200;x<=1200;x+=step){
      ctx.beginPath(); ctx.moveTo(ox+x*s,0); ctx.lineTo(ox+x*s,cv.height); ctx.stroke();
    }
    for(let y=-1200;y<=1200;y+=step){
      ctx.beginPath(); ctx.moveTo(0,oyPix-y*s); ctx.lineTo(cv.width,oyPix-y*s); ctx.stroke();
    }
  }

  function fish(theta1, theta2, l){
    const O = {x:0, y:0};
    const P = {x:l*Math.cos(theta1), y:l*Math.sin(theta1)};
    const Q = {x:l*Math.cos(theta2), y:l*Math.sin(theta2)};

    const dx = Q.x - P.x;
    const dy = Q.y - P.y;
    const d  = Math.hypot(dx, dy);

    let M;
    if (d < 1e-6) {
      // â˜… ç‰¹ç•°ç‚¹å›é¿ï¼ˆå®Œå…¨ã«é‡ãªã£ãŸå ´åˆï¼‰
      M = {
        x: P.x,
        y: P.y + l
      };
    } else {
      const mx = (P.x + Q.x)/2;
      const my = (P.y + Q.y)/2;
      const h  = Math.sqrt(Math.max(0, l*l - (d*d)/4));
      const nx = -dy / d;
      const ny =  dx / d;
      M = {
        x: mx + nx*h,
        y: my + ny*h
      };
    }

    return {O, P, Q, M, theta2};
  }

  function loop(){
    if(running) t += spd.value*0.0008;
    ctx.clearRect(0,0,cv.width,cv.height);
    drawGrid();

    const thetaA = rad(+ta0.value) + rad(+ampA.value)*Math.sin(t);
    const thetaB = rad(+tb0.value) + rad(+ampB.value)*Math.sin(t+rad(+phi.value));
    const {O,P,Q,M,theta2} = fish(thetaA,thetaB,+l.value);

    trail.push(M);
    if(trail.length>TRAIL_MAX) trail.shift();

    // å…¥åŠ›ãƒãƒ¼
    const A={x:-m.value*Math.cos(thetaA), y:-m.value*Math.sin(thetaA)};
    const B={x: m.value*Math.cos(theta2+Math.PI/2), y:m.value*Math.sin(theta2+Math.PI/2)};
    const C={x:+cx.value, y:+cy.value};

    const rA=Math.hypot(A.x-C.x,A.y-C.y);
    const rB=Math.hypot(B.x-C.x,B.y-C.y);

    // ä»Šå‘¨ã®æ›´æ–°
    rA_min_cur=Math.min(rA_min_cur,rA);
    rA_max_cur=Math.max(rA_max_cur,rA);
    rB_min_cur=Math.min(rB_min_cur,rB);
    rB_max_cur=Math.max(rB_max_cur,rB);

    // 1å‘¨å®Œäº†æ¤œå‡º
    const camAngle = t%(2*Math.PI);
    if(camAngle<camAnglePrev){
      rA_min_last=rA_min_cur; rA_max_last=rA_max_cur;
      rB_min_last=rB_min_cur; rB_max_last=rB_max_cur;
      rA_min_cur=Infinity; rA_max_cur=-Infinity;
      rB_min_cur=Infinity; rB_max_cur=-Infinity;
    }
    camAnglePrev=camAngle;

    // æç”»
    drawLine(O,P,3,"#000"); drawLine(O,Q,3,"#000");
    drawLine(P,M,4,"#0a0"); drawLine(Q,M,4,"#0a0");
    drawLine(O,A,4,"#00f"); drawLine(O,B,4,"#f00");
    drawDot(M,5,"green"); drawDot(A,4,"blue"); drawDot(B,4,"red");

    // è»Œè·¡
    ctx.strokeStyle="rgba(0,150,0,0.8)"; ctx.lineWidth=2;
    ctx.beginPath();
    trail.forEach((p,i)=>{const s=W(p); if(i==0)ctx.moveTo(s.x,s.y); else ctx.lineTo(s.x,s.y);});
    ctx.stroke();

    readout.textContent =
`ã€ç›´è¿‘1å‘¨ã®ã‚«ãƒ åŠå¾„ã€‘
A: min=${isNaN(rA_min_last)?"--":rA_min_last.toFixed(1)}  max=${isNaN(rA_max_last)?"--":rA_max_last.toFixed(1)}
B: min=${isNaN(rB_min_last)?"--":rB_min_last.toFixed(1)}  max=${isNaN(rB_max_last)?"--":rB_max_last.toFixed(1)}
C=(${C.x.toFixed(0)}, ${C.y.toFixed(0)})`;

    requestAnimationFrame(loop);
  }

  play.onclick=()=>running=true;
  pause.onclick=()=>running=false;
  clearTrail.onclick=()=>{
    trail.length=0;
    rA_min_cur=Infinity; rA_max_cur=-Infinity;
    rB_min_cur=Infinity; rB_max_cur=-Infinity;
    rA_min_last=NaN; rA_max_last=NaN;
    rB_min_last=NaN; rB_max_last=NaN;
  };

  loop();
})();
</script>
</body>
</html>
