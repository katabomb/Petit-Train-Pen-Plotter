<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ãƒ—ãƒé›»è»Šãƒšãƒ³ãƒ—ãƒ­ãƒƒã‚¿2ï½œã‚«ãƒ æœ€å¤§å¾„ãƒ»æœ€å°å¾„ã¤ã</title>
<style>
  body{font-family:system-ui,Segoe UI,sans-serif;margin:10px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  canvas{border:1px solid #aaa;border-radius:10px}
  .panel{min-width:300px;max-width:480px}
  .card{border:1px solid #ddd;border-radius:12px;padding:10px 12px;margin-bottom:10px}
  label{display:grid;grid-template-columns:1fr 95px;gap:10px;align-items:center;margin:6px 0}
  input[type=range]{width:100%}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:7px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre}
</style>
</head>

<body>
<div class="row">
  <canvas id="cv" width="760" height="950"></canvas>

  <div class="panel">
    <div class="card">
      <div class="btns">
        <button id="play">â–¶ å†ç”Ÿ</button>
        <button id="pause">â¸ åœæ­¢</button>
        <button id="clearTrail">ğŸ§½ è»Œè·¡ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="card">
      <b>å¯¸æ³•</b>
      <label>4ç¯€ãƒªãƒ³ã‚¯é•· l<span id="vl" class="mono"></span>
        <input id="l" type="range" min="60" max="280" value="140">
      </label>
      <label>å…¥åŠ›ãƒãƒ¼é•· m<span id="vm" class="mono"></span>
        <input id="m" type="range" min="80" max="520" value="260">
      </label>
      <label>ã‚ºãƒ¼ãƒ <span id="vz" class="mono"></span>
        <input id="zoom" type="range" min="55" max="150" value="75">
      </label>
    </div>

    <div class="card">
      <b>å…¥åŠ›è§’</b>
      <label>Î¸A0<span id="vta0" class="mono"></span>
        <input id="ta0" type="range" min="-180" max="180" value="45">
      </label>
      <label>Î¸B0<span id="vtb0" class="mono"></span>
        <input id="tb0" type="range" min="-180" max="180" value="135">
      </label>
      <label>æŒ¯å¹…A<span id="vampA" class="mono"></span>
        <input id="ampA" type="range" min="0" max="140" value="35">
      </label>
      <label>æŒ¯å¹…B<span id="vampB" class="mono"></span>
        <input id="ampB" type="range" min="0" max="140" value="55">
      </label>
      <label>ä½ç›¸å·® Ï†<span id="vphi" class="mono"></span>
        <input id="phi" type="range" min="-180" max="180" value="90">
      </label>
    </div>

    <div class="card">
      <b>å…±é€šã‚«ãƒ ä¸­å¿ƒ C</b>
      <label>Cx<span id="vcx" class="mono"></span>
        <input id="cx" type="range" min="-340" max="340" value="0">
      </label>
      <label>Cy<span id="vcy" class="mono"></span>
        <input id="cy" type="range" min="-900" max="-40" value="-260">
      </label>
    </div>

    <div class="card">
      <b>ã‚«ãƒ åŠå¾„ï¼ˆ1å‘¨ï¼‰</b>
      <div id="camStats" class="mono"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const rad = d => d*Math.PI/180;

  let running = true, t = 0;
  const trail = [];
  const TRAIL_MAX = 2500;

  function W(p){
    const s = Number(zoom.value)/100;
    return { x: cv.width/2 + p.x*s, y: cv.height*0.35 - p.y*s };
  }
  function drawLine(p,q,w,c){
    const a=W(p), b=W(q);
    ctx.save(); ctx.lineWidth=w; ctx.strokeStyle=c;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    ctx.restore();
  }
  function drawDot(p,r,c){
    const a=W(p);
    ctx.save(); ctx.fillStyle=c;
    ctx.beginPath(); ctx.arc(a.x,a.y,r,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  function drawCircle(c,r,col){
    const a=W(c), s=Number(zoom.value)/100;
    ctx.save(); ctx.strokeStyle=col; ctx.lineWidth=3;
    ctx.beginPath(); ctx.arc(a.x,a.y,r*s,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }

  function fishFromAngles(theta1, theta2, lval){
    const O={x:0,y:0};
    let dth=theta2-theta1;
    while(dth>Math.PI)dth-=2*Math.PI;
    while(dth<-Math.PI)dth+=2*Math.PI;
    dth*=0.7;
    theta2=theta1+dth;

    const P={x:lval*Math.cos(theta1),y:lval*Math.sin(theta1)};
    const Q={x:lval*Math.cos(theta2),y:lval*Math.sin(theta2)};
    const dx=Q.x-P.x, dy=Q.y-P.y;
    const d=Math.hypot(dx,dy);
    let M;
    if(d<1e-6) M={x:P.x,y:P.y+lval};
    else{
      const mx=(P.x+Q.x)/2,my=(P.y+Q.y)/2;
      const h=Math.sqrt(Math.max(0,lval*lval-(d*d)/4));
      const nx=-dy/d, ny=dx/d;
      const M1={x:mx+nx*h,y:my+ny*h};
      const M2={x:mx-nx*h,y:my-ny*h};
      M=(M1.y>=M2.y)?M1:M2;
    }
    return {O,P,Q,M,theta2};
  }

  function computeCamStats(){
    let minA=Infinity,maxA=-Infinity,minB=Infinity,maxB=-Infinity;
    const steps=720;
    const lval=Number(l.value), mval=Number(m.value);
    const cxv=Number(cx.value), cyv=Number(cy.value);
    for(let i=0;i<steps;i++){
      const ph=2*Math.PI*i/steps;
      const thetaA=rad(Number(ta0.value))+rad(Number(ampA.value))*Math.sin(ph);
      const thetaB=rad(Number(tb0.value))+rad(Number(ampB.value))*Math.sin(ph+rad(Number(phi.value)));
      const fish=fishFromAngles(thetaA,thetaB,lval);
      const A_tip={x:-mval*Math.cos(thetaA),y:-mval*Math.sin(thetaA)};
      const B_tip={x:mval*Math.cos(fish.theta2+Math.PI/2),y:mval*Math.sin(fish.theta2+Math.PI/2)};
      const rA=Math.hypot(A_tip.x-cxv,A_tip.y-cyv);
      const rB=Math.hypot(B_tip.x-cxv,B_tip.y-cyv);
      minA=Math.min(minA,rA); maxA=Math.max(maxA,rA);
      minB=Math.min(minB,rB); maxB=Math.max(maxB,rB);
    }
    camStats.textContent=
`A cam : min ${minA.toFixed(1)}  max ${maxA.toFixed(1)}
B cam : min ${minB.toFixed(1)}  max ${maxB.toFixed(1)}`;
  }

  [l,m,ta0,tb0,ampA,ampB,phi,cx,cy].forEach(el=>el.oninput=computeCamStats);

  function loop(){
    if(running) t+=0.02;
    ctx.clearRect(0,0,cv.width,cv.height);

    const lval=Number(l.value), mval=Number(m.value);
    const thetaA=rad(Number(ta0.value))+rad(Number(ampA.value))*Math.sin(t);
    const thetaB=rad(Number(tb0.value))+rad(Number(ampB.value))*Math.sin(t+rad(Number(phi.value)));

    const fish=fishFromAngles(thetaA,thetaB,lval);
    const O=fish.O,P=fish.P,Q=fish.Q,M=fish.M;

    trail.push(M); if(trail.length>TRAIL_MAX) trail.shift();

    const A_tip={x:-mval*Math.cos(thetaA),y:-mval*Math.sin(thetaA)};
    const B_tip={x:mval*Math.cos(fish.theta2+Math.PI/2),y:mval*Math.sin(fish.theta2+Math.PI/2)};
    const Cc={x:Number(cx.value),y:Number(cy.value)};

    drawLine(O,P,3,"#444"); drawLine(O,Q,3,"#444");
    drawLine(P,M,3,"#080"); drawLine(Q,M,3,"#080");
    for(let i=1;i<trail.length;i++) drawLine(trail[i-1],trail[i],2,"rgba(0,150,0,.6)");

    drawLine(O,A_tip,5,"rgba(0,0,255,.5)");
    drawLine(O,B_tip,5,"rgba(255,0,0,.5)");
    drawDot(M,5,"green");
    drawCircle(Cc,Math.hypot(A_tip.x-Cc.x,A_tip.y-Cc.y),"rgba(0,0,255,.4)");
    drawCircle(Cc,Math.hypot(B_tip.x-Cc.x,B_tip.y-Cc.y),"rgba(255,0,0,.4)");

    requestAnimationFrame(loop);
  }

  play.onclick=()=>running=true;
  pause.onclick=()=>running=false;
  clearTrail.onclick=()=>trail.length=0;

  computeCamStats();
  loop();
})();
</script>
</body>
</html>
