<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ—ãƒé›»è»Šãƒšãƒ³ãƒ—ãƒ­ãƒƒã‚¿2ï¼šãƒªãƒ³ã‚¯æ©Ÿæ§‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼ˆè©¦ä½œï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    canvas { border: 1px solid #bbb; border-radius: 8px; touch-action: none; }
    .panel { min-width: 320px; max-width: 520px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 10px 12px; margin-bottom: 10px; }
    label { display: grid; grid-template-columns: 1fr 90px; gap: 10px; align-items: center; margin: 6px 0; }
    input[type="range"] { width: 100%; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .hint { color: #444; font-size: 13px; line-height: 1.4; }
  </style>
</head>
<body>
  <div class="row">
    <canvas id="cv" width="720" height="720"></canvas>

    <div class="panel">
      <div class="card">
        <div class="btns">
          <button id="btnPlay">â–¶ å†ç”Ÿ</button>
          <button id="btnPause">â¸ åœæ­¢</button>
          <button id="btnStep">â­ 1ã‚¹ãƒ†ãƒƒãƒ—</button>
          <button id="btnClear">ğŸ§½ è»Œè·¡ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="hint" style="margin-top:8px">
          ã“ã‚Œã¯ã€Œå°¾ã®ä»˜ã‘æ ¹ï¼ˆåŸç‚¹ï¼‰ã‹ã‚‰å‡ºã‚‹2æœ¬ã®è…•ã®è§’åº¦ã€ã‚’å…¥åŠ›ã¨ã—ã¦ã€<br>
          4ç¯€ï¼ˆè±å½¢ï¼‰ã®é ‚ç‚¹ã€Œå£ï¼ãƒšãƒ³ä½ç½®ã€ã‚’è¨ˆç®—ã—ã¦è»Œè·¡ã‚’æãã¾ã™ã€‚<br>
          â€»ã‚«ãƒ å½¢çŠ¶â†’è§’åº¦ã®å¤‰æ›ã¯æ¬¡æ®µã§è¿½åŠ ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="card">
        <div class="mono" id="readout"></div>
      </div>

      <div class="card">
        <div class="hint"><b>ãƒªãƒ³ã‚¯ï¼ˆè±å½¢ï¼‰ã®åŸºæœ¬</b></div>
        <label>è¾ºé•· lï¼ˆç”»é¢ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰<span class="mono" id="v_l"></span>
          <input id="l" type="range" min="80" max="260" value="170" />
        </label>
        <label>æç”»å€ç‡ï¼ˆã‚ºãƒ¼ãƒ ï¼‰<span class="mono" id="v_zoom"></span>
          <input id="zoom" type="range" min="60" max="160" value="100" />
        </label>
      </div>

      <div class="card">
        <div class="hint"><b>2å…¥åŠ›ï¼ˆè§’åº¦ï¼‰ï¼â€œã‚«ãƒ ãŒä½œã‚‹å‹•ãâ€ã®ä»£ç”¨å“</b></div>
        <label>åŸºæº–è§’ Î¸1â‚€ï¼ˆåº¦ï¼‰<span class="mono" id="v_t10"></span>
          <input id="t10" type="range" min="-180" max="180" value="45" />
        </label>
        <label>åŸºæº–è§’ Î¸2â‚€ï¼ˆåº¦ï¼‰<span class="mono" id="v_t20"></span>
          <input id="t20" type="range" min="-180" max="180" value="135" />
        </label>

        <label>æŒ¯ã‚Œå¹… A1ï¼ˆåº¦ï¼‰<span class="mono" id="v_a1"></span>
          <input id="a1" type="range" min="0" max="80" value="25" />
        </label>
        <label>æŒ¯ã‚Œå¹… A2ï¼ˆåº¦ï¼‰<span class="mono" id="v_a2"></span>
          <input id="a2" type="range" min="0" max="80" value="25" />
        </label>
        <label>ä½ç›¸å·® Ï†ï¼ˆåº¦ï¼‰<span class="mono" id="v_phi"></span>
          <input id="phi" type="range" min="-180" max="180" value="90" />
        </label>

        <label>é€Ÿåº¦ï¼ˆã‚¹ãƒ†ãƒƒãƒ—/ç§’ï¼‰<span class="mono" id="v_spd"></span>
          <input id="spd" type="range" min="10" max="240" value="60" />
        </label>
      </div>

      <div class="card">
        <div class="hint"><b>è¡¨ç¤º</b></div>
        <label>ãƒªãƒ³ã‚¯è¡¨ç¤º
          <input id="showLink" type="checkbox" checked />
        </label>
        <label>ã‚«ãƒ è§’ï¼ˆç–‘ä¼¼ï¼‰è¡¨ç¤º
          <input id="showTheta" type="checkbox" checked />
        </label>
        <label>è»Œè·¡ã®é•·ã•ï¼ˆç‚¹æ•°ï¼‰<span class="mono" id="v_tr"></span>
          <input id="trail" type="range" min="50" max="8000" value="2500" />
        </label>
      </div>
    </div>
  </div>

<script>
(() => {
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  // UI
  const ui = {
    l: byId("l"), zoom: byId("zoom"),
    t10: byId("t10"), t20: byId("t20"),
    a1: byId("a1"), a2: byId("a2"), phi: byId("phi"),
    spd: byId("spd"), trail: byId("trail"),
    showLink: byId("showLink"), showTheta: byId("showTheta"),
    readout: byId("readout"),
  };

  const labels = {
    v_l: byId("v_l"), v_zoom: byId("v_zoom"),
    v_t10: byId("v_t10"), v_t20: byId("v_t20"),
    v_a1: byId("v_a1"), v_a2: byId("v_a2"), v_phi: byId("v_phi"),
    v_spd: byId("v_spd"), v_tr: byId("v_tr"),
  };

  function byId(id){ return document.getElementById(id); }
  function deg2rad(d){ return d * Math.PI / 180; }
  function rad2deg(r){ return r * 180 / Math.PI; }

  // åº§æ¨™å¤‰æ›ï¼ˆä¸–ç•Œâ†’ç”»é¢ï¼‰
  function worldToScreen(p){
    const zoom = Number(ui.zoom.value) / 100;
    const s = zoom;
    const ox = cv.width * 0.5;
    const oy = cv.height * 0.62; // å°‘ã—ä¸‹ã«åŸç‚¹ã‚’ç½®ã
    return { x: ox + p.x * s, y: oy - p.y * s };
  }

  // 2å…¥åŠ› â†’ 4ç¯€ï¼ˆè±å½¢ï¼‰ â†’ å£ï¼ˆãƒšãƒ³ï¼‰
  //
  // ãƒ¢ãƒ‡ãƒ«:
  //  - å°¾ã®ä»˜ã‘æ ¹ O = (0,0) å›ºå®š
  //  - O ã‹ã‚‰å·¦å³ã®ç¯€ç‚¹ A, B ã¸é•·ã• l ã®æ£’ï¼ˆã“ã‚ŒãŒã€ŒäºŒåˆã®å…¥åŠ›ã€ã ã¨è€ƒãˆã‚‹ï¼‰
  //  - A ã¨ B ã‹ã‚‰ã€Œå£ã€M ã¸ã‚‚é•·ã• l ã®æ£’
  //  â†’ 4æœ¬ã™ã¹ã¦é•·ã• l ã®è±å½¢ï¼ˆ4ç¯€ãƒªãƒ³ã‚¯ï¼‰
  //
  // å…¥åŠ›ã¯è§’åº¦ï¼ˆÎ¸1, Î¸2ï¼‰ã§ã€A = l*[cosÎ¸1, sinÎ¸1], B = l*[cosÎ¸2, sinÎ¸2]
  // M ã¯ã€Œä¸­å¿ƒ A, B åŠå¾„ l ã®å††ã®äº¤ç‚¹ã€ã®ã†ã¡ã€ä¸Šå´ï¼ˆyãŒå¤§ãã„æ–¹ï¼‰ã‚’æ¡ç”¨ã€‚

  function circleIntersections(A, B, r){
    const dx = B.x - A.x;
    const dy = B.y - A.y;
    const d = Math.hypot(dx, dy);
    if (d < 1e-9) return null;
    // è§£ãŒãªã„/ç„¡é™ã®å ´åˆ
    if (d > 2*r) return null;
    // 2å††ã®äº¤ç‚¹
    const a = d/2; // r=r ã®ã¨ãç°¡å˜åŒ–ã•ã‚Œã‚‹
    const h2 = r*r - a*a;
    if (h2 < 0) return null;
    const h = Math.sqrt(h2);

    const mx = A.x + dx * (a/d);
    const my = A.y + dy * (a/d);

    // å‚ç›´æ–¹å‘ã®å˜ä½ãƒ™ã‚¯ãƒˆãƒ«
    const rx = -dy / d;
    const ry =  dx / d;

    const P1 = { x: mx + rx*h, y: my + ry*h };
    const P2 = { x: mx - rx*h, y: my - ry*h };
    return [P1, P2];
  }

  // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
  let running = false;
  let t = 0;            // ç–‘ä¼¼ã€Œã‚«ãƒ è§’ã€(rad)
  let trail = [];       // ãƒšãƒ³è»Œè·¡
  let lastFrame = performance.now();

  // UIè¡¨ç¤ºæ›´æ–°
  function refreshLabels(){
    labels.v_l.textContent    = `${ui.l.value}px`;
    labels.v_zoom.textContent = `${ui.zoom.value}%`;
    labels.v_t10.textContent  = `${ui.t10.value}Â°`;
    labels.v_t20.textContent  = `${ui.t20.value}Â°`;
    labels.v_a1.textContent   = `${ui.a1.value}Â°`;
    labels.v_a2.textContent   = `${ui.a2.value}Â°`;
    labels.v_phi.textContent  = `${ui.phi.value}Â°`;
    labels.v_spd.textContent  = `${ui.spd.value}`;
    labels.v_tr.textContent   = `${ui.trail.value}`;
  }

  // è§’åº¦ç”Ÿæˆï¼ˆã„ã¾ã¯ â€œã‚«ãƒ â†’è§’åº¦â€ ã®ä»£ç”¨ã¨ã—ã¦æ­£å¼¦æ³¢ï¼‰
  function inputAngles(camTheta){
    const t10 = deg2rad(Number(ui.t10.value));
    const t20 = deg2rad(Number(ui.t20.value));
    const a1  = deg2rad(Number(ui.a1.value));
    const a2  = deg2rad(Number(ui.a2.value));
    const phi = deg2rad(Number(ui.phi.value));

    const th1 = t10 + a1 * Math.sin(camTheta);
    const th2 = t20 + a2 * Math.sin(camTheta + phi);
    return { th1, th2 };
  }

  function step(dt){
    const spd = Number(ui.spd.value); // steps/s ç›¸å½“
    // dtç§’ã§ camTheta ã‚’é€²ã‚ã‚‹ï¼ˆä¸€å®šè§’é€Ÿåº¦ã‚’ä»®å®šï¼‰
    t += dt * (spd * 2*Math.PI / 240); // 240stepã§1å‘¨ãã‚‰ã„ã®æ„Ÿè¦š
    // æ­£è¦åŒ–
    if (t > 1e9) t = t % (2*Math.PI);
  }

  function updateTrail(pen){
    const maxN = Number(ui.trail.value);
    trail.push(pen);
    if (trail.length > maxN) trail.splice(0, trail.length - maxN);
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);

    // è»¸ï¼ˆå‚è€ƒï¼‰
    drawAxes();

    const l = Number(ui.l.value);
    const O = {x:0, y:0};

    const { th1, th2 } = inputAngles(t);
    const A = { x: l*Math.cos(th1), y: l*Math.sin(th1) };
    const B = { x: l*Math.cos(th2), y: l*Math.sin(th2) };

    const ints = circleIntersections(A, B, l);
    let M = null;
    if (ints){
      // å£ã¯ä¸Šå´ï¼ˆyãŒå¤§ãã„æ–¹ï¼‰
      M = (ints[0].y >= ints[1].y) ? ints[0] : ints[1];
    }

    // è»Œè·¡
    if (M){
      updateTrail(M);
      drawTrail(trail);
    }

    // ãƒªãƒ³ã‚¯è¡¨ç¤º
    if (ui.showLink.checked){
      drawLink(O, A, B, M);
    }

    // æ–‡å­—è¡¨ç¤º
    const mouthStr = M ? `M=( ${M.x.toFixed(1)}, ${M.y.toFixed(1)} )` : `M=--- (è§£ãªã—)`;
    ui.readout.textContent =
`camÎ¸=${rad2deg(t).toFixed(1)}Â°
Î¸1=${rad2deg(th1).toFixed(1)}Â°   Î¸2=${rad2deg(th2).toFixed(1)}Â°
A=( ${A.x.toFixed(1)}, ${A.y.toFixed(1)} )   B=( ${B.x.toFixed(1)}, ${B.y.toFixed(1)} )
${mouthStr}
æ¡ä»¶: OA=OB=AM=BM=lï¼ˆè±å½¢4ç¯€ãƒªãƒ³ã‚¯ï¼‰`;

    // ç”»é¢å³ä¸Šã«ç–‘ä¼¼ã‚«ãƒ è§’
    if (ui.showTheta.checked){
      ctx.save();
      ctx.font = "14px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.fillStyle = "#333";
      ctx.fillText(`camÎ¸ ${rad2deg(t).toFixed(1)}Â°`, 14, 24);
      ctx.restore();
    }
  }

  function drawAxes(){
    const O = worldToScreen({x:0,y:0});
    ctx.save();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#eee";
    // grid
    const zoom = Number(ui.zoom.value) / 100;
    const step = 50 * zoom;
    for (let x=0; x<=cv.width; x+=step){
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cv.height); ctx.stroke();
    }
    for (let y=0; y<=cv.height; y+=step){
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cv.width,y); ctx.stroke();
    }
    // axes
    ctx.strokeStyle = "#ccc";
    ctx.beginPath(); ctx.moveTo(0,O.y); ctx.lineTo(cv.width,O.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(O.x,0); ctx.lineTo(O.x,cv.height); ctx.stroke();
    ctx.restore();
  }

  function drawTrail(tr){
    if (tr.length < 2) return;
    ctx.save();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#111";
    ctx.beginPath();
    const p0 = worldToScreen(tr[0]);
    ctx.moveTo(p0.x, p0.y);
    for (let i=1; i<tr.length; i++){
      const p = worldToScreen(tr[i]);
      ctx.lineTo(p.x, p.y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawLink(O, A, B, M){
    // ç¯€ç‚¹
    const Os = worldToScreen(O);
    const As = worldToScreen(A);
    const Bs = worldToScreen(B);

    ctx.save();
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#000";

    // O-A, O-B
    ctx.beginPath(); ctx.moveTo(Os.x, Os.y); ctx.lineTo(As.x, As.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(Os.x, Os.y); ctx.lineTo(Bs.x, Bs.y); ctx.stroke();

    if (M){
      const Ms = worldToScreen(M);
      // A-M, B-M
      ctx.beginPath(); ctx.moveTo(As.x, As.y); ctx.lineTo(Ms.x, Ms.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(Bs.x, Bs.y); ctx.lineTo(Ms.x, Ms.y); ctx.stroke();

      // ãƒšãƒ³ï¼ˆå£ï¼‰
      drawNode(Ms, 7, "#fff", "#000");
      ctx.font = "14px system-ui";
      ctx.fillStyle = "#000";
      ctx.fillText("PEN", Ms.x + 10, Ms.y - 6);
    }

    // å°¾ã®ä»˜ã‘æ ¹ãƒ»å·¦å³ç¯€ç‚¹
    drawNode(Os, 7, "#fff", "#000");
    drawNode(As, 6, "#fff", "#000");
    drawNode(Bs, 6, "#fff", "#000");

    ctx.restore();
  }

  function drawNode(ps, r, fill, stroke){
    ctx.save();
    ctx.beginPath();
    ctx.arc(ps.x, ps.y, r, 0, Math.PI*2);
    ctx.fillStyle = fill; ctx.fill();
    ctx.strokeStyle = stroke; ctx.lineWidth = 2; ctx.stroke();
    ctx.restore();
  }

  // ãƒ«ãƒ¼ãƒ—
  function loop(now){
    const dt = Math.min(0.05, (now - lastFrame) / 1000);
    lastFrame = now;

    if (running){
      step(dt);
    }
    draw();
    requestAnimationFrame(loop);
  }

  // ãƒœã‚¿ãƒ³
  byId("btnPlay").addEventListener("click", () => running = true);
  byId("btnPause").addEventListener("click", () => running = false);
  byId("btnStep").addEventListener("click", () => { running = false; step(1/60); draw(); });
  byId("btnClear").addEventListener("click", () => { trail = []; draw(); });

  // UIå¤‰æ›´ã§å³åæ˜ 
  Object.values(ui).forEach(el => {
    if (!el || !el.addEventListener) return;
    el.addEventListener("input", () => { refreshLabels(); draw(); });
  });

  // åˆæœŸåŒ–
  refreshLabels();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
