
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>お絵描き → αβz 出力（下絵・グリッド対応）</title>
<style>
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
margin:0;background:#fff;color:#111}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:8px;border-bottom:1px solid #ccc}
canvas{touch-action:none}
#wrap{display:flex;gap:8px;padding:8px}
#left{flex:0 0 auto}
#right{flex:1 1 auto}
textarea{width:100%;height:240px}
label{font-size:12px}
</style>
</head>
<body>
<div class="toolbar">
<label>下絵<input type="file" id="bgFile"></label>
<label>透過<input type="range" id="bgAlpha" min="0" max="1" step="0.05" value="0.3"></label>
<label><input type="checkbox" id="gridOn" checked>グリッド</label>
<label>l<input type="number" id="lArm" value="90" style="width:70px"></label>
<label>x0<input type="number" id="x0Off" value="0" style="width:70px"></label>
<label>y0<input type="number" id="y0Off" value="130" style="width:70px"></label>
<label>行数<select id="nRows"><option>360</option><option>720</option></select></label>
<button id="clearBtn">クリア</button>
</div>
<div id="wrap">
<div id="left">
<canvas id="bg" width="360" height="360"></canvas><br>
<canvas id="grid" width="360" height="360"></canvas><br>
<canvas id="draw" width="360" height="360" style="border:1px solid #999"></canvas>
</div>
<div id="right">
<textarea id="out"></textarea>
</div>
</div>

<script>
const bg=document.getElementById('bg'), g=document.getElementById('grid'), c=document.getElementById('draw');
const bctx=bg.getContext('2d'), gctx=g.getContext('2d'), ctx=c.getContext('2d');
const out=document.getElementById('out');
let strokes=[], cur=null, drawing=false;

function redraw(){
  ctx.clearRect(0,0,c.width,c.height);
  ctx.lineWidth=2; ctx.strokeStyle="#06f";
  for(const s of strokes){
    ctx.beginPath();
    s.forEach((p,i)=>{ if(i==0)ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
  }
}

function drawGrid(){
  gctx.clearRect(0,0,g.width,g.height);
  if(!gridOn.checked) return;
  gctx.strokeStyle="#ddd";
  for(let i=0;i<=360;i+=30){
    gctx.beginPath(); gctx.moveTo(i,0); gctx.lineTo(i,360); gctx.stroke();
    gctx.beginPath(); gctx.moveTo(0,i); gctx.lineTo(360,i); gctx.stroke();
  }
}
drawGrid();

c.addEventListener('pointerdown',e=>{
  drawing=true; cur=[]; strokes.push(cur);
  const r=c.getBoundingClientRect();
  cur.push({x:e.clientX-r.left,y:e.clientY-r.top});
});
c.addEventListener('pointermove',e=>{
  if(!drawing) return;
  const r=c.getBoundingClientRect();
  cur.push({x:e.clientX-r.left,y:e.clientY-r.top});
  redraw(); updateOut();
});
c.addEventListener('pointerup',()=>{drawing=false; cur=null; updateOut();});
clearBtn.onclick=()=>{strokes=[]; redraw(); updateOut();};

bgFile.onchange=e=>{
  const f=e.target.files[0]; if(!f)return;
  const img=new Image();
  img.onload=()=>{
    bctx.clearRect(0,0,bg.width,bg.height);
    bctx.globalAlpha=bgAlpha.value;
    bctx.drawImage(img,0,0,360,360);
    bctx.globalAlpha=1;
  };
  img.src=URL.createObjectURL(f);
};
bgAlpha.oninput=()=>{
  bctx.clearRect(0,0,bg.width,bg.height);
  if(bgFile.files.length) bgFile.onchange({target:{files:bgFile.files}});
};

function deg(r){return r*180/Math.PI}
function wrapNear(p,v){if(!isFinite(p))return v; while(v-p>180)v-=360; while(v-p<-180)v+=360; return v}
function ik(x,y,l,pa,pb){
  const rho=Math.hypot(x,y), phi=Math.atan2(y,x), g=Math.acos(Math.min(rho/(2*l),1));
  let A=wrapNear(pa,deg(phi+g)), B=wrapNear(pb,deg(phi-g));
  return {A:(A+360)%360,B:(B+360)%360};
}

function updateOut(){
  const N=+nRows.value, l=+lArm.value, x0=+x0Off.value, y0=+y0Off.value;
  let pts=[];
  strokes.forEach(s=>s.forEach(p=>pts.push({...p,z:1})));
  if(pts.length<2){ out.value=""; return; }
  let res=[];
  for(let i=0;i<N;i++){
    const t=i/(N-1), idx=Math.floor(t*(pts.length-1));
    res.push(pts[idx]);
  }
  let pa=NaN,pb=NaN, lines=[];
  res.forEach(p=>{
    const x=x0+p.x/360*100, y=y0+(360-p.y)/360*100;
    const ab=ik(x,y,l,pa,pb);
    pa=ab.A; pb=ab.B;
    lines.push(`${ab.A.toFixed(2)},${ab.B.toFixed(2)},1`);
  });
  out.value=lines.join("\n");
}
</script>
</body>
</html>
