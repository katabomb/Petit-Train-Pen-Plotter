<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>プチ電車ペンプロッタ2（v2.1 修正版）</title>
<style>
body{margin:0;font-family:system-ui;background:#0b0c10;color:#e9ecf1}
header{padding:10px;border-bottom:1px solid #2a3142}
.wrap{display:grid;grid-template-columns:minmax(260px,360px) 1fr;gap:10px;padding:10px}
@media(max-width:900px){.wrap{grid-template-columns:1fr}}
.card{background:#141722;border:1px solid #2a3142;border-radius:12px;padding:10px}
textarea,input,button{width:100%;margin:4px 0;padding:6px;border-radius:8px;border:1px solid #2a3142;background:#0f1220;color:#e9ecf1}
button{cursor:pointer}
.canvasWrap{aspect-ratio:3/4}
canvas{width:100%;height:100%;background:#070812}
.small{font-size:12px;color:#aab2c0}
</style>
</head>
<body>
<header>
<h3>プチ電車ペンプロッタ2（v2.1 修正版）</h3>
<p class="small">※ 起動直後は何もしません。サンプルを読み込むか線文を入力してください。</p>
</header>
<div class="wrap">
<section class="card">
<h4>線文</h4>
<textarea id="strokes" placeholder="x,y を1行ずつ。空行でストローク区切り"></textarea>
<button id="loadSquare">サンプル：正方形</button>
<button id="recalc">再計算</button>
<button id="play">▶ 再生</button>
<p class="small" id="msg"></p>
</section>
<section class="card">
<div class="canvasWrap"><canvas id="anim" width="800" height="1100"></canvas></div>
</section>
</div>
<script>
const msg=document.getElementById("msg");
const ta=document.getElementById("strokes");
const cvs=document.getElementById("anim");
const ctx=cvs.getContext("2d");
let path=[],t=0,playing=false;

function parse(){
  const lines=ta.value.split(/\n/).map(l=>l.trim()).filter(l=>l);
  if(lines.length<2){return null;}
  return lines.map(l=>l.split(",").map(Number));
}

function compute(){
  const p=parse();
  if(!p){msg.textContent="線文が空、または点が足りません"; return false;}
  path=p; t=0; msg.textContent="計算OK"; draw(); return true;
}

function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.strokeStyle="#7dd3fc"; ctx.lineWidth=2;
  ctx.beginPath();
  for(let i=0;i<=t;i++){
    const [x,y]=path[i];
    const px=400+x*5, py=550-y*5;
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

function tick(){
  if(!playing) return;
  t=(t+1)%path.length;
  draw();
  requestAnimationFrame(tick);
}

document.getElementById("recalc").onclick=compute;
document.getElementById("play").onclick=()=>{
  if(!path.length){ if(!compute()) return; }
  playing=true; tick();
};

document.getElementById("loadSquare").onclick=()=>{
  ta.value="-40,-40\n40,-40\n40,40\n-40,40\n-40,-40";
  compute();
};
</script>
</body>
</html>
